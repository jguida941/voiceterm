# Purpose: Runs the bounded CodeRabbit remediation loop for medium/high backlog items.
# Details: See .github/workflows/README.md for triggers, jobs, and failure handling.
name: CodeRabbit Ralph Loop

permissions:
  contents: write
  actions: read
  pull-requests: write
  issues: write

concurrency:
  group: coderabbit-ralph-loop-${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

on:
  workflow_run: # zizmor: ignore[dangerous-triggers] guarded to same-repo trusted branch events in job-level if
    workflows:
      - CodeRabbit Triage Bridge
    branches:
      - develop
      - master
    types:
      - completed
  workflow_dispatch:
    inputs:
      branch:
        description: Branch to monitor for CodeRabbit backlog
        required: true
        default: develop
        type: string
      max_attempts:
        description: Maximum bounded remediation attempts
        required: false
        default: "3"
        type: string
      poll_seconds:
        description: Poll interval in seconds when waiting for new runs
        required: false
        default: "20"
        type: string
      timeout_seconds:
        description: Timeout in seconds per wait window
        required: false
        default: "1800"
        type: string
      execution_mode:
        description: Loop behavior (report-only, plan-then-fix, or fix-only)
        required: false
        default: plan-then-fix
        type: choice
        options:
          - report-only
          - plan-then-fix
          - fix-only
      notify_mode:
        description: Notification mode for loop output
        required: false
        default: summary-and-comment
        type: choice
        options:
          - summary-only
          - summary-and-comment
      comment_target:
        description: Comment target selection for summary-and-comment
        required: false
        default: auto
        type: choice
        options:
          - auto
          - pr
          - commit
      comment_pr_number:
        description: Optional explicit PR number for comment-target=pr/auto
        required: false
        type: string
      fix_command:
        description: Optional auto-fix command (must commit/push a new SHA)
        required: false
        type: string

jobs:
  loop:
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' ||
        (
          github.event.workflow_run.head_repository.full_name == github.repository &&
          vars.RALPH_LOOP_MODE != 'disabled' &&
          (
            vars.RALPH_LOOP_MODE == '' ||
            vars.RALPH_LOOP_MODE == 'always' ||
            (
              vars.RALPH_LOOP_MODE == 'failure-only' &&
              (
                github.event.workflow_run.conclusion == 'failure' ||
                github.event.workflow_run.conclusion == 'timed_out' ||
                github.event.workflow_run.conclusion == 'cancelled' ||
                github.event.workflow_run.conclusion == 'action_required'
              )
            )
          )
        )
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event.workflow_run.head_sha }}

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Resolve loop configuration
        id: cfg
        env:
          EVENT_NAME: ${{ github.event_name }}
          DISPATCH_BRANCH: ${{ inputs.branch }}
          DISPATCH_MAX_ATTEMPTS: ${{ inputs.max_attempts }}
          DISPATCH_POLL_SECONDS: ${{ inputs.poll_seconds }}
          DISPATCH_TIMEOUT_SECONDS: ${{ inputs.timeout_seconds }}
          DISPATCH_EXECUTION_MODE: ${{ inputs.execution_mode }}
          DISPATCH_NOTIFY_MODE: ${{ inputs.notify_mode }}
          DISPATCH_COMMENT_TARGET: ${{ inputs.comment_target }}
          DISPATCH_COMMENT_PR_NUMBER: ${{ inputs.comment_pr_number }}
          DISPATCH_FIX_COMMAND: ${{ inputs.fix_command }}
          WORKFLOW_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
          WORKFLOW_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          LOOP_MAX_ATTEMPTS: ${{ vars.RALPH_LOOP_MAX_ATTEMPTS }}
          LOOP_POLL_SECONDS: ${{ vars.RALPH_LOOP_POLL_SECONDS }}
          LOOP_TIMEOUT_SECONDS: ${{ vars.RALPH_LOOP_TIMEOUT_SECONDS }}
          LOOP_EXECUTION_MODE: ${{ vars.RALPH_EXECUTION_MODE }}
          LOOP_NOTIFY_MODE: ${{ vars.RALPH_NOTIFY_MODE }}
          LOOP_COMMENT_TARGET: ${{ vars.RALPH_COMMENT_TARGET }}
          LOOP_COMMENT_PR_NUMBER: ${{ vars.RALPH_COMMENT_PR_NUMBER }}
          LOOP_FIX_COMMAND: ${{ vars.RALPH_LOOP_FIX_COMMAND }}
        run: |
          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            BRANCH="${DISPATCH_BRANCH}"
            MAX_ATTEMPTS="${DISPATCH_MAX_ATTEMPTS:-3}"
            POLL_SECONDS="${DISPATCH_POLL_SECONDS:-20}"
            TIMEOUT_SECONDS="${DISPATCH_TIMEOUT_SECONDS:-1800}"
            EXECUTION_MODE="${DISPATCH_EXECUTION_MODE:-plan-then-fix}"
            NOTIFY_MODE="${DISPATCH_NOTIFY_MODE:-summary-and-comment}"
            COMMENT_TARGET="${DISPATCH_COMMENT_TARGET:-auto}"
            COMMENT_PR_NUMBER="${DISPATCH_COMMENT_PR_NUMBER}"
            SOURCE_EVENT="workflow_dispatch"
            SOURCE_RUN_ID=""
            SOURCE_RUN_SHA=""
            FIX_COMMAND="${DISPATCH_FIX_COMMAND}"
          else
            BRANCH="${WORKFLOW_BRANCH}"
            MAX_ATTEMPTS="${LOOP_MAX_ATTEMPTS:-3}"
            POLL_SECONDS="${LOOP_POLL_SECONDS:-20}"
            TIMEOUT_SECONDS="${LOOP_TIMEOUT_SECONDS:-1800}"
            EXECUTION_MODE="${LOOP_EXECUTION_MODE:-plan-then-fix}"
            NOTIFY_MODE="${LOOP_NOTIFY_MODE:-summary-and-comment}"
            COMMENT_TARGET="${LOOP_COMMENT_TARGET:-auto}"
            COMMENT_PR_NUMBER="${LOOP_COMMENT_PR_NUMBER}"
            SOURCE_EVENT="workflow_run"
            SOURCE_RUN_ID="${WORKFLOW_RUN_ID}"
            SOURCE_RUN_SHA="${WORKFLOW_HEAD_SHA}"
            FIX_COMMAND="${LOOP_FIX_COMMAND:-python3 dev/scripts/devctl.py check --profile ci}"
          fi

          if [[ -z "${BRANCH}" ]]; then
            echo "Branch is required."
            exit 1
          fi
          if [[ ! "${MAX_ATTEMPTS}" =~ ^[0-9]+$ || "${MAX_ATTEMPTS}" -lt 1 ]]; then
            echo "Invalid max attempts: ${MAX_ATTEMPTS}"
            exit 1
          fi
          if [[ ! "${POLL_SECONDS}" =~ ^[0-9]+$ || "${POLL_SECONDS}" -lt 5 ]]; then
            echo "Invalid poll seconds: ${POLL_SECONDS}"
            exit 1
          fi
          if [[ ! "${TIMEOUT_SECONDS}" =~ ^[0-9]+$ || "${TIMEOUT_SECONDS}" -lt 60 ]]; then
            echo "Invalid timeout seconds: ${TIMEOUT_SECONDS}"
            exit 1
          fi
          case "${EXECUTION_MODE}" in
            report-only|plan-then-fix|fix-only) ;;
            *)
              echo "Invalid execution mode: ${EXECUTION_MODE}"
              exit 1
              ;;
          esac
          case "${NOTIFY_MODE}" in
            summary-only|summary-and-comment) ;;
            *)
              echo "Invalid notify mode: ${NOTIFY_MODE}"
              exit 1
              ;;
          esac
          case "${COMMENT_TARGET}" in
            auto|pr|commit) ;;
            *)
              echo "Invalid comment target: ${COMMENT_TARGET}"
              exit 1
              ;;
          esac
          if [[ "${SOURCE_EVENT}" == "workflow_run" ]]; then
            if [[ -z "${SOURCE_RUN_ID}" || ! "${SOURCE_RUN_ID}" =~ ^[0-9]+$ ]]; then
              echo "workflow_run source requires numeric run id"
              exit 1
            fi
            if [[ -z "${SOURCE_RUN_SHA}" ]]; then
              echo "workflow_run source requires head sha"
              exit 1
            fi
          fi

          {
            echo "branch=${BRANCH}"
            echo "max_attempts=${MAX_ATTEMPTS}"
            echo "poll_seconds=${POLL_SECONDS}"
            echo "timeout_seconds=${TIMEOUT_SECONDS}"
            echo "execution_mode=${EXECUTION_MODE}"
            echo "notify_mode=${NOTIFY_MODE}"
            echo "comment_target=${COMMENT_TARGET}"
            echo "comment_pr_number=${COMMENT_PR_NUMBER}"
            echo "source_event=${SOURCE_EVENT}"
            echo "source_run_id=${SOURCE_RUN_ID}"
            echo "source_run_sha=${SOURCE_RUN_SHA}"
          } >> "${GITHUB_OUTPUT}"

          {
            echo "fix_command<<EOF"
            echo "${FIX_COMMAND}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Run CodeRabbit Ralph loop
        env:
          GH_TOKEN: ${{ github.token }}
          AUTONOMY_MODE: ${{ vars.AUTONOMY_MODE }}
          TRIAGE_LOOP_ALLOWED_PREFIXES: ${{ vars.TRIAGE_LOOP_ALLOWED_PREFIXES }}
          FIX_COMMAND: ${{ steps.cfg.outputs.fix_command }}
          MODE: ${{ steps.cfg.outputs.execution_mode }}
          TARGET_REPO: ${{ github.repository }}
          TARGET_BRANCH: ${{ steps.cfg.outputs.branch }}
          MAX_ATTEMPTS: ${{ steps.cfg.outputs.max_attempts }}
          POLL_SECONDS: ${{ steps.cfg.outputs.poll_seconds }}
          TIMEOUT_SECONDS: ${{ steps.cfg.outputs.timeout_seconds }}
          NOTIFY_MODE: ${{ steps.cfg.outputs.notify_mode }}
          COMMENT_TARGET: ${{ steps.cfg.outputs.comment_target }}
          COMMENT_PR_NUMBER: ${{ steps.cfg.outputs.comment_pr_number }}
          SOURCE_EVENT: ${{ steps.cfg.outputs.source_event }}
          SOURCE_RUN_ID: ${{ steps.cfg.outputs.source_run_id }}
          SOURCE_RUN_SHA: ${{ steps.cfg.outputs.source_run_sha }}
        run: |
          CMD=(
            python3 dev/scripts/devctl.py triage-loop
            --repo "${TARGET_REPO}"
            --branch "${TARGET_BRANCH}"
            --workflow "CodeRabbit Triage Bridge"
            --max-attempts "${MAX_ATTEMPTS}"
            --poll-seconds "${POLL_SECONDS}"
            --timeout-seconds "${TIMEOUT_SECONDS}"
            --mode "${MODE}"
            --notify "${NOTIFY_MODE}"
            --comment-target "${COMMENT_TARGET}"
            --source-event "${SOURCE_EVENT}"
            --emit-bundle
            --bundle-dir /tmp
            --bundle-prefix coderabbit-ralph-loop
            --mp-proposal
            --json-output /tmp/coderabbit-ralph-loop.json
            --format md
            --output /tmp/coderabbit-ralph-loop.md
          )
          if [[ -n "${COMMENT_PR_NUMBER}" ]]; then
            CMD+=(--comment-pr-number "${COMMENT_PR_NUMBER}")
          fi
          if [[ -n "${SOURCE_RUN_ID}" ]]; then
            CMD+=(--source-run-id "${SOURCE_RUN_ID}")
          fi
          if [[ -n "${SOURCE_RUN_SHA}" ]]; then
            CMD+=(--source-run-sha "${SOURCE_RUN_SHA}")
          fi
          if [[ "${MODE}" != "report-only" && -n "${FIX_COMMAND}" ]]; then
            CMD+=(--fix-command "${FIX_COMMAND}")
          fi
          "${CMD[@]}"

      - name: Publish loop summary
        if: always()
        env:
          SUMMARY_BRANCH: ${{ steps.cfg.outputs.branch }}
          SUMMARY_MODE: ${{ steps.cfg.outputs.execution_mode }}
          SUMMARY_NOTIFY: ${{ steps.cfg.outputs.notify_mode }}
          SUMMARY_MAX_ATTEMPTS: ${{ steps.cfg.outputs.max_attempts }}
        run: |
          echo "## CodeRabbit Ralph Loop" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "- branch: \`${SUMMARY_BRANCH}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- mode: \`${SUMMARY_MODE}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- notify: \`${SUMMARY_NOTIFY}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- max_attempts: \`${SUMMARY_MAX_ATTEMPTS}\`" >> "${GITHUB_STEP_SUMMARY}"
          if [[ -f /tmp/coderabbit-ralph-loop.md ]]; then
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "### Report" >> "${GITHUB_STEP_SUMMARY}"
            echo '```md' >> "${GITHUB_STEP_SUMMARY}"
            sed -n '1,120p' /tmp/coderabbit-ralph-loop.md >> "${GITHUB_STEP_SUMMARY}"
            echo '```' >> "${GITHUB_STEP_SUMMARY}"
          fi
          if [[ -f /tmp/coderabbit-ralph-loop-master-plan-proposal.md ]]; then
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "### MASTER_PLAN proposal preview" >> "${GITHUB_STEP_SUMMARY}"
            echo '```md' >> "${GITHUB_STEP_SUMMARY}"
            sed -n '1,80p' /tmp/coderabbit-ralph-loop-master-plan-proposal.md >> "${GITHUB_STEP_SUMMARY}"
            echo '```' >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Upload Ralph loop artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coderabbit-ralph-loop-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            /tmp/coderabbit-ralph-loop.md
            /tmp/coderabbit-ralph-loop.json
            /tmp/coderabbit-ralph-loop-master-plan-proposal.md
          if-no-files-found: error
          retention-days: 21
