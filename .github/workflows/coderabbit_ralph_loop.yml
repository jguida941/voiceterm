name: CodeRabbit Ralph Loop

permissions:
  contents: write
  actions: read

concurrency:
  group: coderabbit-ralph-loop-${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

on:
  workflow_run:
    workflows:
      - CodeRabbit Triage Bridge
    branches:
      - develop
      - master
    types:
      - completed
  workflow_dispatch:
    inputs:
      branch:
        description: Branch to monitor for CodeRabbit backlog
        required: true
        default: develop
        type: string
      max_attempts:
        description: Maximum bounded remediation attempts
        required: false
        default: "3"
        type: string
      poll_seconds:
        description: Poll interval in seconds when waiting for new runs
        required: false
        default: "20"
        type: string
      timeout_seconds:
        description: Timeout in seconds per wait window
        required: false
        default: "1800"
        type: string
      fix_command:
        description: Optional auto-fix command (must commit/push a new SHA)
        required: false
        type: string

jobs:
  loop:
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' ||
        (
          vars.RALPH_LOOP_ENABLED == 'true' &&
          github.event.workflow_run.head_repository.full_name == github.repository &&
          (
            github.event.workflow_run.conclusion == 'failure' ||
            github.event.workflow_run.conclusion == 'timed_out' ||
            github.event.workflow_run.conclusion == 'cancelled' ||
            github.event.workflow_run.conclusion == 'action_required'
          )
        )
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event.workflow_run.head_sha }}

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Resolve loop configuration
        id: cfg
        env:
          DISPATCH_BRANCH: ${{ inputs.branch }}
          DISPATCH_MAX_ATTEMPTS: ${{ inputs.max_attempts }}
          DISPATCH_POLL_SECONDS: ${{ inputs.poll_seconds }}
          DISPATCH_TIMEOUT_SECONDS: ${{ inputs.timeout_seconds }}
          DISPATCH_FIX_COMMAND: ${{ inputs.fix_command }}
          LOOP_MAX_ATTEMPTS: ${{ vars.RALPH_LOOP_MAX_ATTEMPTS }}
          LOOP_POLL_SECONDS: ${{ vars.RALPH_LOOP_POLL_SECONDS }}
          LOOP_TIMEOUT_SECONDS: ${{ vars.RALPH_LOOP_TIMEOUT_SECONDS }}
          LOOP_FIX_COMMAND: ${{ vars.RALPH_LOOP_FIX_COMMAND }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH="${DISPATCH_BRANCH}"
            MAX_ATTEMPTS="${DISPATCH_MAX_ATTEMPTS:-3}"
            POLL_SECONDS="${DISPATCH_POLL_SECONDS:-20}"
            TIMEOUT_SECONDS="${DISPATCH_TIMEOUT_SECONDS:-1800}"
            FIX_COMMAND="${DISPATCH_FIX_COMMAND}"
          else
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            MAX_ATTEMPTS="${LOOP_MAX_ATTEMPTS:-3}"
            POLL_SECONDS="${LOOP_POLL_SECONDS:-20}"
            TIMEOUT_SECONDS="${LOOP_TIMEOUT_SECONDS:-1800}"
            FIX_COMMAND="${LOOP_FIX_COMMAND}"
          fi

          if [[ -z "${BRANCH}" ]]; then
            echo "Branch is required."
            exit 1
          fi
          if [[ ! "${MAX_ATTEMPTS}" =~ ^[0-9]+$ || "${MAX_ATTEMPTS}" -lt 1 ]]; then
            echo "Invalid max attempts: ${MAX_ATTEMPTS}"
            exit 1
          fi
          if [[ ! "${POLL_SECONDS}" =~ ^[0-9]+$ || "${POLL_SECONDS}" -lt 5 ]]; then
            echo "Invalid poll seconds: ${POLL_SECONDS}"
            exit 1
          fi
          if [[ ! "${TIMEOUT_SECONDS}" =~ ^[0-9]+$ || "${TIMEOUT_SECONDS}" -lt 60 ]]; then
            echo "Invalid timeout seconds: ${TIMEOUT_SECONDS}"
            exit 1
          fi

          {
            echo "branch=${BRANCH}"
            echo "max_attempts=${MAX_ATTEMPTS}"
            echo "poll_seconds=${POLL_SECONDS}"
            echo "timeout_seconds=${TIMEOUT_SECONDS}"
          } >> "${GITHUB_OUTPUT}"

          {
            echo "fix_command<<EOF"
            echo "${FIX_COMMAND}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Run CodeRabbit Ralph loop
        env:
          GH_TOKEN: ${{ github.token }}
          FIX_COMMAND: ${{ steps.cfg.outputs.fix_command }}
        run: |
          CMD=(
            python3 dev/scripts/checks/run_coderabbit_ralph_loop.py
            --repo "${{ github.repository }}"
            --branch "${{ steps.cfg.outputs.branch }}"
            --max-attempts "${{ steps.cfg.outputs.max_attempts }}"
            --poll-seconds "${{ steps.cfg.outputs.poll_seconds }}"
            --timeout-seconds "${{ steps.cfg.outputs.timeout_seconds }}"
            --json-output /tmp/coderabbit-ralph-loop.json
            --output /tmp/coderabbit-ralph-loop.md
          )
          if [[ -n "${FIX_COMMAND}" ]]; then
            CMD+=(--fix-command "${FIX_COMMAND}")
          fi
          "${CMD[@]}"

      - name: Publish loop summary
        if: always()
        run: |
          echo "## CodeRabbit Ralph Loop" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "- branch: \`${{ steps.cfg.outputs.branch }}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- max_attempts: \`${{ steps.cfg.outputs.max_attempts }}\`" >> "${GITHUB_STEP_SUMMARY}"
          if [[ -f /tmp/coderabbit-ralph-loop.md ]]; then
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "### Report" >> "${GITHUB_STEP_SUMMARY}"
            echo '```md' >> "${GITHUB_STEP_SUMMARY}"
            sed -n '1,120p' /tmp/coderabbit-ralph-loop.md >> "${GITHUB_STEP_SUMMARY}"
            echo '```' >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Upload Ralph loop artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: coderabbit-ralph-loop-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            /tmp/coderabbit-ralph-loop.md
            /tmp/coderabbit-ralph-loop.json
          if-no-files-found: error
          retention-days: 21
