name: publish_pypi

on:
  release:
    types: [published]

permissions:
  contents: read
  actions: read

concurrency:
  group: publish-pypi-${{ github.event.release.tag_name }}
  cancel-in-progress: false

jobs:
  publish:
    name: publish-pypi
    runs-on: ubuntu-latest
    if: startsWith(github.event.release.tag_name, 'v')
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Resolve release ref
        id: release_ref
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_TARGET_BRANCH: ${{ github.event.release.target_commitish }}
        run: |
          TAG="${RELEASE_TAG}"
          BRANCH="${RELEASE_TARGET_BRANCH}"
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid release tag: ${TAG}"
            exit 1
          fi
          if [[ -z "${BRANCH}" ]]; then
            echo "Release target branch is missing."
            exit 1
          fi
          git fetch --force --tags origin
          SHA="$(git rev-list -n 1 "refs/tags/${TAG}")"
          if [[ -z "${SHA}" ]]; then
            echo "Failed to resolve commit SHA for tag ${TAG}."
            exit 1
          fi
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "branch=${BRANCH}" >> "${GITHUB_OUTPUT}"
          echo "sha=${SHA}" >> "${GITHUB_OUTPUT}"

      - name: Verify CodeRabbit gate passed for release commit
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_BRANCH: ${{ steps.release_ref.outputs.branch }}
          RELEASE_SHA: ${{ steps.release_ref.outputs.sha }}
        run: |
          python3 dev/scripts/checks/check_coderabbit_gate.py \
            --branch "${RELEASE_BRANCH}" \
            --sha "${RELEASE_SHA}" \
            --format md

      - name: Verify CodeRabbit Ralph gate passed for release commit
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_BRANCH: ${{ steps.release_ref.outputs.branch }}
          RELEASE_SHA: ${{ steps.release_ref.outputs.sha }}
        run: |
          python3 dev/scripts/checks/check_coderabbit_ralph_gate.py \
            --branch "${RELEASE_BRANCH}" \
            --sha "${RELEASE_SHA}" \
            --format md

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"

      - name: Install PyPI tooling
        run: python3 -m pip install --upgrade pip build twine

      - name: Validate PyPI secret
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [[ -z "${PYPI_API_TOKEN:-}" ]]; then
            echo "Missing required repository secret: PYPI_API_TOKEN"
            exit 1
          fi

      - name: Publish to PyPI via devctl ship
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${RELEASE_TAG}"
          VERSION="${VERSION#v}"
          python3 dev/scripts/devctl.py ship --version "${VERSION}" --pypi --verify-pypi --yes --allow-ci
